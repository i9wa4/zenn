---
title: "Zsh compinit ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦èµ·å‹•æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹"
emoji: "ğŸ´"
type: "tech"
topics:
  - "zsh"
published: true
---

## 1. ã¯ã˜ã‚ã«

Zsh ã®èµ·å‹•æ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ã¨ compinit å‡¦ç†ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
compinit ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã€é©åˆ‡ã«è¨­å®šã™ã‚‹ã“ã¨ã§èµ·å‹•æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

Zinit ã‚’ä½¿ã£ãŸèµ·å‹•æ™‚é–“çŸ­ç¸®ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚‚åˆã‚ã›ã¦ã”è¦§ãã ã•ã„ã€‚
ä»¥ä¸‹ã®è¨˜äº‹ã§ã¯ compinit ã‚’é…å»¶èª­ã¿è¾¼ã¿ã™ã‚‹æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

@[card](https://zenn.dev/i9wa4/articles/2026-01-01-zsh-startup-optimization-zinit)

ä»¥é™ã§ã¯ compinit ã®å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹æ–¹æ³•ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

## 2. ç’°å¢ƒ

- macOS 26.2
- Zsh 5.9

## 3. compinit ã¨ã¯

compinit ã¯ Zsh ã®è£œå®Œã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°ã§ã™ã€‚

```zsh
autoload -Uz compinit
compinit
```

ã“ã®2è¡Œã§è£œå®Œæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚compinit ã‚’å®Ÿè¡Œã—ãªã„ã¨ Tab ã‚­ãƒ¼ã«ã‚ˆã‚‹è£œå®ŒãŒæ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

## 4. zcompdump ã¨ã¯

compinit ã¯å‡¦ç†çµæœã‚’ zcompdump ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

```text
~/.zcompdump
```

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¸­èº«:

- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ (è£œå®Œãƒ•ã‚¡ã‚¤ãƒ«æ•°ã€zsh ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
- ã‚³ãƒãƒ³ãƒ‰ã¨è£œå®Œé–¢æ•°ã®ãƒãƒƒãƒ”ãƒ³ã‚°
- è‡ªå‹•èª­ã¿è¾¼ã¿è¨­å®š

## 5. compinit ã®è‡ªå‹•åˆ¤å®šæ©Ÿèƒ½

compinit ã¯æ¯å›å®Ÿè¡Œæ™‚ã«ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™:

- fpath å†…ã®è£œå®Œãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤‰ã‚ã£ãŸã‹
- Zsh ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰ã‚ã£ãŸã‹

å¤‰ã‚ã£ã¦ã„ã‚Œã° zcompdump ã‚’å†ç”Ÿæˆã—ã€å¤‰ã‚ã£ã¦ã„ãªã‘ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^1]ã‹ã‚‰å¼•ç”¨:

> If the number of completion files changes, compinit will recognise this and produce a new dump file.

ã¤ã¾ã‚Šã€å…¬å¼ã«ã¯æ¯å› `compinit` ã‚’å®Ÿè¡Œã™ã‚Œã°ã‚ˆãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé »åº¦ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## 6. ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

hyperfine ã§è¨ˆæ¸¬ã—ãŸçµæœã§ã™ (10å›å®Ÿè¡Œã®å¹³å‡)ã€‚

| æ–¹å¼                         | å®Ÿè¡Œæ™‚é–“ |
| ---                          | ---      |
| compinit (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—)    | 157.7ms  |
| compinit (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š)    | 30.1ms   |
| compinit -C (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š) | 18.1ms   |

### 6.1. å·®åˆ†

| æ¯”è¼ƒ                | å·®            |
| ---                 | ---           |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åŠ¹æœ    | ç´„ 128ms çŸ­ç¸® |
| -C ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åŠ¹æœ | ç´„ 12ms çŸ­ç¸®  |

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å­˜åœ¨ãŒæœ€ã‚‚é‡è¦ã§ã™ã€‚

## 7. -C ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã¯

compinit -C ã¯åˆ¤å®šå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^1]ã‹ã‚‰å¼•ç”¨:

> The check performed to see if there are new functions can be omitted by giving the option -C. In this case the dump file will only be created if there isn't one already.

ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹å‡¦ç†:

- compaudit (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯)
- æ–°è¦è£œå®Œé–¢æ•°ã®è‡ªå‹•æ¤œå‡º
- ãƒ€ãƒ³ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿæˆãƒã‚§ãƒƒã‚¯

## 8. é«˜é€ŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³

### 8.1. å…¬å¼ã®æ–¹å¼

```zsh
autoload -Uz compinit
compinit
```

æ¯å›å®Ÿè¡Œã€‚å†…éƒ¨ã§è‡ªå‹•åˆ¤å®šã—ã¾ã™ã€‚

### 8.2. 24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³

åˆ¤å®šå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¤ã¤ã€å®šæœŸçš„ã«ãƒ•ãƒ«å®Ÿè¡Œã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```zsh
autoload -Uz compinit
_zcompdump="${XDG_CACHE_HOME:-${HOME}/.cache}/zsh/.zcompdump-${HOST}-${ZSH_VERSION}"
mkdir -p "${_zcompdump:h}"

setopt extendedglob
if [[ -n "${_zcompdump}"(#qN.mh+24) ]]; then
  compinit -d "${_zcompdump}"
else
  compinit -C -d "${_zcompdump}"
fi
```

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ ctechols ã® Gist[^2] ãŒãŠãã‚‰ãèµ·æºã§ã™ã€‚

### 8.3. glob qualifier ã®èª¬æ˜

`(#qN.mh+24)` ã¯ Zsh ã® glob qualifier ã§ã™ã€‚

| è¨˜å·    | æ„å‘³                           |
| ---     | ---                            |
| `#q`    | glob qualifier ã¨ã—ã¦è§£é‡ˆ      |
| `N`     | ãƒãƒƒãƒã—ãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„ |
| `.`     | é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿               |
| `mh+24` | ä¿®æ­£æ™‚åˆ»ãŒ24æ™‚é–“ä»¥ä¸Šå‰         |

glob qualifier ã‚’ä½¿ã†ã«ã¯ `setopt extendedglob` ãŒå¿…è¦ã§ã™ã€‚

## 9. ã©ã¡ã‚‰ã‚’é¸ã¶ã¹ãã‹

| æ–¹å¼                 | ãƒ¡ãƒªãƒƒãƒˆ       | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ   |
| ---                  | ---            | ---          |
| å…¬å¼ (æ¯å› compinit) | ã‚·ãƒ³ãƒ—ãƒ«ã€ç¢ºå®Ÿ | ç´„ 12ms é…ã„ |
| 24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥     | ç´„ 12ms é€Ÿã„   | è¤‡é›‘ã€éå…¬å¼ |

12ms ã®å·®ãŒæ°—ã«ãªã‚‹ãªã‚‰ 24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’é‡è¦–ã™ã‚‹ãªã‚‰å…¬å¼æ–¹å¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚

## 10. ãŠã‚ã‚Šã«

compinit ã®æœ€é©åŒ–ã¯ã»ã‚“ã®åƒ…ã‹ãªåŠ¹æœã§ã™ãŒã€æ°—ã«ãªã‚‹å ´åˆã¯è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼

[^1]: [zsh: 20 Completion System](https://zsh.sourceforge.io/Doc/Release/Completion-System.html)

[^2]: [ctechols Gist - Speed up zsh compinit by only checking cache once a day](https://gist.github.com/ctechols/ca1035271ad134841284)
